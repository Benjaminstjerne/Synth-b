<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Crystal Glock Garden</title>

<style>
html,body{
margin:0;
overflow:hidden;
background:#ffffff;
touch-action:none;
}
</style>
</head>

<body>

<script src="https://cdn.jsdelivr.net/npm/three@0.160/build/three.min.js"></script>

<script>

//////////////// AUDIO //////////////////

const ctx=new (window.AudioContext||webkitAudioContext)();
const master=ctx.createGain();
master.gain.value=.5;
master.connect(ctx.destination);

// pentatonic scale
const scale=[1,9/8,5/4,3/2,5/3,2];

// ---------- GLOCK ----------

function glock(freq){

const car=ctx.createOscillator();
const mod=ctx.createOscillator();
const mg=ctx.createGain();
const amp=ctx.createGain();

car.type="sine";
mod.type="sine";

mod.frequency.value=freq*2.7;
mg.gain.value=freq*1.5;

mod.connect(mg);
mg.connect(car.frequency);

car.frequency.value=freq;

const hp=ctx.createBiquadFilter();
hp.type="highpass";
hp.frequency.value=800;

car.connect(hp);
hp.connect(amp);
amp.connect(master);

amp.gain.setValueAtTime(0,ctx.currentTime);
amp.gain.linearRampToValueAtTime(.8,ctx.currentTime+.002);
amp.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.8);

car.start();
mod.start();

car.stop(ctx.currentTime+1);
mod.stop(ctx.currentTime+1);
}

// ---------- GONG ----------

function gong(freq){

const o=ctx.createOscillator();
o.type="triangle";
o.frequency.value=freq*.5;

const bp=ctx.createBiquadFilter();
bp.type="bandpass";
bp.frequency.value=200;

const amp=ctx.createGain();

o.connect(bp);
bp.connect(amp);
amp.connect(master);

amp.gain.setValueAtTime(0,ctx.currentTime);
amp.gain.linearRampToValueAtTime(.6,ctx.currentTime+.05);
amp.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+5);

o.start();
o.stop(ctx.currentTime+6);
}

//////////////// THREE //////////////////

const scene=new THREE.Scene();
scene.background=new THREE.Color(0xfdfefe);

const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,.1,100);
camera.position.z=4;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

const geo=new THREE.SphereGeometry(1,48,48);
const base=geo.attributes.position.array.slice();

const mat=new THREE.MeshPhysicalMaterial({
color:0xffffff,
roughness:.05,
transmission:.8,
thickness:.5,
clearcoat:1
});

const mesh=new THREE.Mesh(geo,mat);
scene.add(mesh);

scene.add(new THREE.DirectionalLight(0xffffff,2));
scene.add(new THREE.AmbientLight(0xffffff,.9));

//////////////// INTERACTION //////////////////

let target={x:.5,y:.5,z:0};
let smooth={x:.5,y:.5,z:0};

function lerp(a,b,t){return a+(b-a)*t;}

addEventListener("pointermove",e=>{
target.x=e.clientX/innerWidth;
target.y=1-e.clientY/innerHeight;
});

addEventListener("pointerdown",()=>ctx.resume());

if(DeviceMotionEvent){
addEventListener("devicemotion",e=>{
if(e.rotationRate){
target.x+=e.rotationRate.gamma*.0003;
target.y+=e.rotationRate.beta*.0003;
target.z=e.accelerationIncludingGravity.z*.001;
}
});
}

//////////////// LOOP //////////////////

let last=0;

function animate(t){

requestAnimationFrame(animate);

smooth.x=lerp(smooth.x,target.x,.05);
smooth.y=lerp(smooth.y,target.y,.05);
smooth.z=lerp(smooth.z,target.z,.05);

let pos=geo.attributes.position.array;
for(let i=0;i<pos.length;i++){
pos[i]=base[i]*(1+Math.sin(t*.001+i)*.01);
}
geo.attributes.position.needsUpdate=true;

mesh.rotation.y+=.001+smooth.x*.01;

let now=performance.now();

if(now-last>300){
last=now;

let root=220+smooth.y*440;
let ratio=scale[Math.floor(smooth.x*scale.length)];
glock(root*ratio);

if(Math.random()<.15){
gong(root*.5);
}
}

renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
