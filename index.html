<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Living Crystal Orb</title>

<style>
html,body{
margin:0;
overflow:hidden;
background:white;
touch-action:none;
}
</style>
</head>

<body>

<script src="https://cdn.jsdelivr.net/npm/three@0.160/build/three.min.js"></script>

<script>

//////////////// AUDIO //////////////////

const ctx=new (window.AudioContext||webkitAudioContext)();
const master=ctx.createGain();
master.gain.value=.5;
master.connect(ctx.destination);

const scale=[1,9/8,5/4,3/2,5/3,2];

function glock(freq){

const o1=ctx.createOscillator();
const o2=ctx.createOscillator();
const g=ctx.createGain();

o1.type="sine";
o2.type="sine";

o2.frequency.value=freq*2.41;

o1.frequency.value=freq;

o2.connect(o1.frequency);

o1.connect(g);
g.connect(master);

g.gain.setValueAtTime(0,ctx.currentTime);
g.gain.linearRampToValueAtTime(.7,ctx.currentTime+.002);
g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.7);

o1.start();
o2.start();

o1.stop(ctx.currentTime+1);
o2.stop(ctx.currentTime+1);
}

function gong(freq){

const o=ctx.createOscillator();
const bp=ctx.createBiquadFilter();
const g=ctx.createGain();

o.type="triangle";
o.frequency.value=freq*.4;

bp.type="bandpass";
bp.frequency.value=180;

o.connect(bp);
bp.connect(g);
g.connect(master);

g.gain.setValueAtTime(0,ctx.currentTime);
g.gain.linearRampToValueAtTime(.6,ctx.currentTime+.05);
g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+5);

o.start();
o.stop(ctx.currentTime+6);
}

//////////////// THREE //////////////////

const scene=new THREE.Scene();
scene.background=new THREE.Color(0xffffff);

const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,.1,100);
camera.position.z=4;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

const geo=new THREE.SphereGeometry(1,64,64);
const base=geo.attributes.position.array.slice();

const mat=new THREE.MeshPhysicalMaterial({
color:0xffffff,
roughness:.05,
transmission:.85,
thickness:.6,
clearcoat:1
});

const mesh=new THREE.Mesh(geo,mat);
scene.add(mesh);

scene.add(new THREE.DirectionalLight(0xffffff,2));
scene.add(new THREE.AmbientLight(0xffffff,1));

//////////////// INTERACTION //////////////////

let motion=0;
let target={x:.5,y:.5,z:0};
let smooth={x:.5,y:.5,z:0};

function lerp(a,b,t){return a+(b-a)*t;}

function resume(){
ctx.resume();
}

addEventListener("pointerdown",resume);
addEventListener("touchstart",resume);

if(DeviceMotionEvent){
DeviceMotionEvent.requestPermission?.().catch(()=>{});
addEventListener("devicemotion",e=>{
if(e.accelerationIncludingGravity){
motion+=Math.abs(e.accelerationIncludingGravity.x||0)*.02;
motion+=Math.abs(e.accelerationIncludingGravity.y||0)*.02;
motion+=Math.abs(e.accelerationIncludingGravity.z||0)*.02;

target.x+=(e.rotationRate?.gamma||0)*.0004;
target.y+=(e.rotationRate?.beta||0)*.0004;
target.z=(e.accelerationIncludingGravity.z||0)*.002;
}
});
}

addEventListener("pointermove",e=>{
target.x=e.clientX/innerWidth;
target.y=1-e.clientY/innerHeight;
});

// fullscreen anywhere

function fullscreen(){
if(!document.fullscreenElement){
document.documentElement.requestFullscreen();
}
}

let lastTap=0;
addEventListener("pointerup",()=>{
let now=performance.now();
if(now-lastTap<400) fullscreen();
lastTap=now;
fullscreen();
});

//////////////// LOOP //////////////////

let lastNote=0;

function animate(t){

requestAnimationFrame(animate);

smooth.x=lerp(smooth.x,target.x,.03);
smooth.y=lerp(smooth.y,target.y,.03);
smooth.z=lerp(smooth.z,target.z,.03);

motion*=.98;

let chaos=motion+Math.abs(smooth.z);

// organic deformation

let pos=geo.attributes.position.array;
for(let i=0;i<pos.length;i++){
let n=Math.sin(i*12.9898+t*.001)*43758.5453;
n=n-Math.floor(n);
pos[i]=base[i]*(1+Math.sin(t*.002+i+n*10)*.06*chaos);
}
geo.attributes.position.needsUpdate=true;

mesh.rotation.x+=.002+smooth.y*.02;
mesh.rotation.y+=.003+smooth.x*.02;

mesh.scale.setScalar(1+.15*Math.sin(t*.002)+chaos*.2);

// sound from movement

let now=performance.now();
if(motion>.2 && now-lastNote>180){

lastNote=now;

let root=220+smooth.y*440;
let ratio=scale[Math.floor(Math.random()*scale.length)];

glock(root*ratio);

if(motion>1.2){
gong(root*.4);
motion=0;
}
}

renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
